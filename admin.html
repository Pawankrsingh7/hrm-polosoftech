<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
    <style>
      body {
        background: #f8fafc;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      }
      .page-wrap {
        max-width: 1300px;
        margin: 24px auto;
        padding: 0 12px;
      }
      .table-wrap {
        background: #fff;
        border-radius: 12px;
        padding: 14px;
        box-shadow: 0 8px 24px rgba(15, 23, 42, 0.08);
      }
      .table-responsive {
        max-height: 74vh;
      }
      th {
        white-space: nowrap;
        position: sticky;
        top: 0;
        background: #f1f5f9 !important;
        z-index: 1;
      }
      td {
        white-space: nowrap;
        vertical-align: middle;
      }
      .dept-badge {
        display: inline-block;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: #e6fffa;
        color: #0f766e;
      }
      .details-overlay {
        position: fixed;
        inset: 0;
        background: rgba(15, 23, 42, 0.5);
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 2000;
        padding: 16px;
      }
      .details-overlay.show {
        display: flex;
      }
      .details-card {
        width: 100%;
        max-width: 1000px;
        max-height: 88vh;
        overflow: auto;
        background: #fff;
        border-radius: 12px;
        box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
      }
      .details-header {
        padding: 14px 18px;
        border-bottom: 1px solid #e2e8f0;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .details-body {
        padding: 18px;
      }
      .detail-section {
        margin-bottom: 16px;
        border: 1px solid #e2e8f0;
        border-radius: 10px;
      }
      .detail-section h6 {
        margin: 0;
        padding: 10px 12px;
        background: #f8fafc;
        border-bottom: 1px solid #e2e8f0;
        font-weight: 600;
      }
      .detail-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(230px, 1fr));
        gap: 8px;
        padding: 12px;
      }
      .detail-item {
        font-size: 13px;
        color: #0f172a;
      }
      .detail-item strong {
        color: #334155;
      }
    </style>
  </head>
  <body>
    <div class="page-wrap">
      <div class="d-flex flex-wrap justify-content-between align-items-center gap-2 mb-3">
        <div>
          <h4 class="mb-1">Admin Dashboard</h4>
          <small class="text-muted">Employee submissions</small>
        </div>
        <div class="d-flex gap-2">
          <button id="refreshBtn" class="btn btn-outline-primary">Refresh</button>
          <button id="downloadBtn" class="btn btn-success">Download Excel</button>
          <button id="logoutBtn" class="btn btn-outline-danger">Logout</button>
        </div>
      </div>

      <div id="statusBox" class="alert alert-info d-none"></div>

      <div class="table-wrap">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <strong id="totalRows">Total rows: 0</strong>
        </div>
        <div class="table-responsive">
          <table class="table table-bordered table-hover table-sm" id="dataTable">
            <thead>
              <tr>
                <th>Full Name</th>
                <th>Email</th>
                <th>Department</th>
                <th>Designation</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody id="tableBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="details-overlay" id="detailsOverlay">
      <div class="details-card">
        <div class="details-header">
          <h5 class="mb-0" id="detailsTitle">Employee Details</h5>
          <button class="btn btn-sm btn-outline-secondary" id="closeDetailsBtn">Close</button>
        </div>
        <div class="details-body" id="detailsBody"></div>
      </div>
    </div>

    <script>
      const TOKEN_KEY = 'adminAuthToken';
      let submissionRows = [];

      function getToken() {
        return localStorage.getItem(TOKEN_KEY);
      }

      function showStatus(message, type = 'info') {
        const box = document.getElementById('statusBox');
        box.className = `alert alert-${type}`;
        box.textContent = message;
        box.classList.remove('d-none');
      }

      function clearStatus() {
        const box = document.getElementById('statusBox');
        box.classList.add('d-none');
      }

      function escapeHtml(value) {
        return String(value ?? '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#039;');
      }

      async function ensureAuth() {
        const token = getToken();
        if (!token) {
          window.location.href = '/admin/login';
          return null;
        }

        const response = await fetch('/api/admin/me', {
          headers: { Authorization: `Bearer ${token}` }
        });

        if (!response.ok) {
          localStorage.removeItem(TOKEN_KEY);
          window.location.href = '/admin/login';
          return null;
        }

        return token;
      }

      function renderTable(rows) {
        const bodyEl = document.getElementById('tableBody');
        bodyEl.innerHTML = '';

        if (!rows || rows.length === 0) {
          bodyEl.innerHTML = `
            <tr>
              <td colspan="5" class="text-center text-muted">No records available</td>
            </tr>
          `;
          return;
        }

        rows.forEach((row, index) => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${escapeHtml(row.fullName || '-')}</td>
            <td>${escapeHtml(row.email || '-')}</td>
            <td><span class="dept-badge">${escapeHtml(row.department || '-')}</span></td>
            <td>${escapeHtml(row.designation || '-')}</td>
            <td>
              <button class="btn btn-sm btn-outline-secondary" data-index="${index}" data-action="details">
                See Details
              </button>
            </td>
          `;
          bodyEl.appendChild(tr);
        });
      }

      function sectionTemplate(title, items) {
        const content = items
          .map(({ label, value }) => `<div class="detail-item"><strong>${escapeHtml(label)}:</strong> ${escapeHtml(value || '-')}</div>`)
          .join('');

        return `
          <div class="detail-section">
            <h6>${escapeHtml(title)}</h6>
            <div class="detail-grid">${content}</div>
          </div>
        `;
      }

      function renderDetails(entry) {
        const formData = entry?.formData || {};
        const personal = formData.personal || {};
        const company = formData.company || {};
        const address = formData.address || {};
        const identification = formData.identification || {};
        const other = formData.other || {};
        const education = Array.isArray(formData.education) ? formData.education : [];
        const experience = Array.isArray(formData.experience) ? formData.experience : [];

        const title = document.getElementById('detailsTitle');
        const body = document.getElementById('detailsBody');

        title.textContent = personal.fullName || `${personal.firstName || ''} ${personal.lastName || ''}`.trim() || 'Employee Details';

        let html = '';
        html += sectionTemplate('Personal', [
          { label: 'Salutation', value: personal.salutation },
          { label: 'First Name', value: personal.firstName },
          { label: 'Last Name', value: personal.lastName },
          { label: 'Full Name', value: personal.fullName },
          { label: "Father's Name", value: personal.fatherName },
          { label: 'Date of Joining', value: personal.dateOfJoining },
          { label: 'Contact Number', value: personal.contactNumber },
          { label: 'Email Address', value: personal.emailAddress },
          { label: 'Gender', value: personal.gender },
          { label: 'Marital Status', value: personal.maritalStatus },
          { label: 'Date of Birth', value: personal.dateOfBirth },
          { label: 'Blood Group', value: personal.bloodGroup }
        ]);

        html += sectionTemplate('Company', [
          { label: 'Branch', value: company.branch },
          { label: 'Department', value: company.department },
          { label: 'Designation', value: company.designation },
          { label: 'Report To', value: company.reportTo }
        ]);

        html += sectionTemplate('Address', [
          { label: 'Personal Email', value: address.personalEmail },
          { label: 'Company Email', value: address.companyEmail },
          { label: 'Current Address', value: address.currentAddress },
          { label: 'Permanent Address', value: address.permanentAddress },
          { label: 'Country', value: address.country },
          { label: 'State', value: address.state },
          { label: 'District', value: address.district },
          { label: 'City', value: address.city },
          { label: 'Pincode', value: address.pincode }
        ]);

        html += sectionTemplate('Identification', [
          { label: 'Aadhar Number', value: identification.aadharNumber },
          { label: 'PAN Number', value: identification.panNumber },
          { label: 'Passport Number', value: identification.passportNumber }
        ]);

        html += sectionTemplate('Other Information', [
          { label: 'Previous Interview', value: other.previousInterview },
          { label: 'Previous Interview Details', value: other.previousInterviewDetails },
          { label: 'Criminal Case', value: other.criminalCase },
          { label: 'Criminal Case Details', value: other.criminalCaseDetails },
          { label: 'Disability', value: other.disability },
          { label: 'Disability Details', value: other.disabilityDetails },
          { label: 'E-Signature', value: other.esignature },
          { label: 'Signature Date', value: other.signatureDate },
          { label: 'Signature Place', value: other.signaturePlace }
        ]);

        const educationHtml = education.length
          ? education
              .map((edu, idx) => sectionTemplate(`Education ${idx + 1}`, [
                { label: 'Education Level', value: edu.level },
                { label: 'Qualification', value: edu.qualification },
                { label: 'Year of Passing', value: edu.yearOfPassing },
                { label: 'Institute Name', value: edu.instituteName },
                { label: 'Board/University', value: edu.boardUniversity },
                { label: 'Percentage', value: edu.percentage },
                { label: 'Specialization', value: edu.specialization }
              ]))
              .join('')
          : sectionTemplate('Education', [{ label: 'Details', value: 'No education details provided' }]);

        const experienceHtml = experience.length
          ? experience
              .map((exp, idx) => sectionTemplate(`Experience ${idx + 1}`, [
                { label: 'Company', value: exp.company },
                { label: 'Designation', value: exp.designation },
                { label: 'From Date', value: exp.fromDate },
                { label: 'To Date', value: exp.toDate },
                { label: 'Company Address', value: exp.experienceAddress },
                { label: 'Company Contact', value: exp.companyContact },
                { label: 'CTC', value: exp.ctc },
                { label: 'Reason for Leaving', value: exp.reasonForLeaving }
              ]))
              .join('')
          : sectionTemplate('Experience', [{ label: 'Details', value: 'No experience details provided' }]);

        body.innerHTML = html + educationHtml + experienceHtml;
      }

      function openDetails(index) {
        const entry = submissionRows[index];
        if (!entry) return;

        renderDetails(entry);
        document.getElementById('detailsOverlay').classList.add('show');
      }

      function closeDetails() {
        document.getElementById('detailsOverlay').classList.remove('show');
      }

      async function loadEntries() {
        clearStatus();
        const token = await ensureAuth();
        if (!token) return;

        try {
          const response = await fetch('/api/admin/submissions', {
            headers: { Authorization: `Bearer ${token}` }
          });

          const result = await response.json();
          if (!response.ok || !result.success) {
            throw new Error(result.message || 'Failed to fetch records');
          }

          submissionRows = result.rows || [];
          renderTable(submissionRows);
          document.getElementById('totalRows').textContent = `Total rows: ${result.totalRows || 0}`;
        } catch (error) {
          showStatus(error.message || 'Error loading data', 'danger');
        }
      }

      async function downloadExcel() {
        const token = await ensureAuth();
        if (!token) return;

        try {
          const response = await fetch('/api/admin/download-excel', {
            headers: { Authorization: `Bearer ${token}` }
          });

          if (!response.ok) {
            const err = await response.json().catch(() => ({}));
            throw new Error(err.message || 'Download failed');
          }

          const blob = await response.blob();
          const url = window.URL.createObjectURL(blob);
          const link = document.createElement('a');
          link.href = url;
          link.download = 'employee_data.xlsx';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          window.URL.revokeObjectURL(url);
        } catch (error) {
          showStatus(error.message || 'Unable to download file', 'danger');
        }
      }

      function logout() {
        localStorage.removeItem(TOKEN_KEY);
        window.location.href = '/admin/login';
      }

      document.getElementById('refreshBtn').addEventListener('click', loadEntries);
      document.getElementById('downloadBtn').addEventListener('click', downloadExcel);
      document.getElementById('logoutBtn').addEventListener('click', logout);
      document.getElementById('closeDetailsBtn').addEventListener('click', closeDetails);
      document.getElementById('detailsOverlay').addEventListener('click', (e) => {
        if (e.target.id === 'detailsOverlay') {
          closeDetails();
        }
      });
      document.getElementById('tableBody').addEventListener('click', (e) => {
        const btn = e.target.closest('button[data-action="details"]');
        if (!btn) return;
        const idx = Number(btn.dataset.index);
        if (!Number.isNaN(idx)) {
          openDetails(idx);
        }
      });

      loadEntries();
    </script>
  </body>
</html>
